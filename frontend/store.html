<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>CatÃ¡logo Â· Hathor Imports</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./assets/style.css" />
  <style>
    .filters h3 {
      margin-bottom: 12px;
    }

    .filters label {
      font-size: 14px;
      margin-top: 12px;
      display: block;
    }

    .filters select,
    .filters button {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      border-radius: 8px;
    }

    .filters button {
      margin-top: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <script src="/js/loadHeader.js" defer></script>

  <script type="module" src="./js/home-page.js"></script>
  <main class="page">

    <section class="catalog-section">
      <div class="catalog-layout">

        <!-- FILTROS -->
        <aside class="filters">
          <h3>Filtrar</h3>

          <label>Marca</label>
          <select id="filterBrand">
            <option value="">Todas</option>
          </select>

          <label>Modelo</label>
          <select id="filterModel">
            <option value="">Todos</option>
          </select>

          <button id="clearFilters">Limpar filtros</button>
          <br>
          <br>
          <input id="searchInput" type="text" placeholder="Buscar por nome, categoria..." class="search-bar"
        style="width:100%;padding:10px;margin-bottom:14px;border-radius:8px;">
        </aside>
        <br><br>

        <!-- PRODUTOS -->
        <div id="storeList" class="product-grid"></div>

        <h2 style="display: none;">Todos os produtos</h2><br>

        

        <div id="storeList" class="product-grid"></div>


      </div>
    </section>

    <br>

  </main>

  <script type="module">
    import { listProducts, getCachedProducts } from "./js/store.js";

    const list = document.getElementById("storeList");
    const searchInput = document.getElementById("searchInput");
    const filterBrand = document.getElementById("filterBrand");
    const filterModel = document.getElementById("filterModel");
    const clearFilters = document.getElementById("clearFilters");

    let cache = [];

    async function load() {
      const cached = getCachedProducts();

      if (cached && cached.length) {
        cache = cached;
        populateFilters(cache);
        render(cache);
        return;
      }

      cache = await listProducts();
      populateFilters(cache);
      render(cache);
    }


    function render(items) {
      if (!items.length) {
        list.innerHTML = "<p>Nenhum produto encontrado.</p>";
        return;
      }

      list.innerHTML = items.map((p) => {
        const img = (p.images && p.images[0]) ||
          "https://placehold.co/600x400?text=Hathor";

        const original = Number(p.originalPrice || p.price || 0);
        const final = Number(p.price || p.finalPrice || original);
        const hasPromo = original > final;
        const desconto = hasPromo ? Math.round(((original - final) / original) * 100) : 0;

        return `
      <a href="./product.html?id=${p.id}" class="product-link">
        <article class="product-card ${hasPromo ? "promo" : ""}">
        
          ${hasPromo ? `<div class="promo-badge">${desconto}% OFF</div>` : ""}
          
          <img src="${img}" class="product-thumb" loading="lazy">
          
          <div class="product-info">
            <h3>${p.title}</h3>

            ${hasPromo ? `
              <p class="old-price">R$ ${original.toFixed(2)}</p>
              <p class="new-price">R$ ${final.toFixed(2)}</p>
              <p class="save-tag">Economize ${desconto}% ðŸ¤‘</p>
            ` : `
              <p class="product-price">R$ ${final.toFixed(2)}</p>
            `}
          </div>

        </article>
      </a>
      `;
      }).join("");
    }

    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      const filtered = cache.filter(p =>
        p.title.toLowerCase().includes(q) ||
        (p.categoryLabel && p.categoryLabel.toLowerCase().includes(q))
      );
      render(filtered);
    });
    function populateFilters(products) {
      const brands = new Set();
      const models = new Set();

      products.forEach(p => {
        if (p.brand && typeof p.brand === "string") {
          brands.add(p.brand);
        }

        if (p.model && typeof p.model === "string") {
          models.add(p.model);
        }
      });

      filterBrand.innerHTML =
        `<option value="">Todas</option>` +
        [...brands].sort().map(b =>
          `<option value="${b}">${b}</option>`
        ).join("");

      filterModel.innerHTML =
        `<option value="">Todos</option>` +
        [...models].sort().map(m =>
          `<option value="${m}">${m}</option>`
        ).join("");
    }


    function applyFilters() {
      const selectedBrand = filterBrand.value;
      const selectedModel = filterModel.value;

      const filtered = cache.filter(p => {
        if (selectedBrand && p.brand !== selectedBrand) return false;
        if (selectedModel && p.model !== selectedModel) return false;
        return true;
      });

      render(filtered);
    }


    filterModel.addEventListener("change", applyFilters);

    clearFilters.addEventListener("click", () => {
      filterBrand.value = "";
      filterModel.value = "";
      render(cache);
    });

    filterBrand.addEventListener("change", () => {
      const brand = filterBrand.value;

      const models = new Set();

      cache.forEach(p => {
        if (
          (!brand || p.brand === brand) &&
          p.model &&
          typeof p.model === "string"
        ) {
          models.add(p.model);
        }
      });

      filterModel.innerHTML =
        `<option value="">Todos</option>` +
        [...models].sort().map(m =>
          `<option value="${m}">${m}</option>`
        ).join("");

      applyFilters();
    });



    load();
  </script>


</body>

</html>