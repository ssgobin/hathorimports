<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Checkout Â· Hathor Imports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="./assets/style.css" />

    <style>
        .checkout-container {
            max-width: 750px;
            margin: 40px auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .checkout-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #111;
        }

        .checkout-group {
            margin-bottom: 20px;
        }

        .checkout-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: #444;
        }

        .checkout-group input,
        .checkout-group textarea,
        .checkout-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fafafa;
            font-size: 1rem;
            outline: none;
        }

        .checkout-row {
            display: flex;
            gap: 12px;
        }

        .checkout-row .checkout-group {
            flex: 1;
        }

        .checkout-summary {
            margin-top: 25px;
            padding: 20px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .checkout-summary-total {
            font-size: 1.4rem;
            font-weight: 700;
            color: #111;
            margin-top: 10px;
            text-align: right;
        }

        .btn-primary.full {
            margin-top: 25px;
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2rem;
        }

        header.topbar {
            padding: 20px;
            background: #111;
            color: #fff;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .frete-box {
            background: #eef2ff;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #ccd5ff;
            margin-top: 10px;
        }
    </style>

</head>

<body>

      <header class="topbar">
    <div class="brand">
      <img src="./assets/hathor-logo.png" alt="Hathor Imports" class="logo-img" />
    </div>

    <!-- MENU PREMIUM -->
    <nav class="main-nav">
      <a href="./index.html" class="nav-link">InÃ­cio</a>
      <a href="./cart.html" class="btn-outline">Carrinho ðŸ›’</a>

    </nav>
  </header>

    <main class="page">
        <div class="checkout-container">

            <h1 class="checkout-title">Finalizar Pedido</h1>

            <form id="checkoutForm">

                <div class="checkout-group">
                    <label>Nome completo</label>
                    <input type="text" id="nameInput" required>
                </div>

                <div class="checkout-group">
                    <label>Whatsapp</label>
                    <input type="text" id="whatsappInput" required placeholder="11999999999">
                </div>

                <!-- CEP e FRETE -->
                <div class="checkout-row">
                    <div class="checkout-group">
                        <label>CEP</label>
                        <input type="text" id="cepInput" required>
                    </div>
                </div>

                <div class="checkout-group">
                    <label>Rua</label>
                    <input type="text" id="streetInput" required>
                </div>

                <div class="checkout-row">
                    <div class="checkout-group">
                        <label>NÃºmero</label>
                        <input type="text" id="numberInput" required>
                    </div>

                    <div class="checkout-group">
                        <label>Bairro</label>
                        <input type="text" id="districtInput" required>
                    </div>
                </div>

                <div class="checkout-row">
                    <div class="checkout-group">
                        <label>Cidade</label>
                        <input type="text" id="cityInput" required>
                    </div>

                    <div class="checkout-group">
                        <label>Estado</label>
                        <input type="text" id="stateInput" required>
                    </div>
                </div>

                <div class="frete-box" id="freteBox" style="display:none;">
                    <strong>Frete calculado:</strong> R$ <span id="freteValor">0,00</span>
                </div>

                <!-- MÃ‰TODO DE PAGAMENTO -->
                <div class="checkout-group">
                    <label>MÃ©todo de pagamento</label>
                    <select id="paymentMethod" required>
                        <option value="">Selecione...</option>
                        <option value="PIX">PIX</option>
                        <option value="CartÃ£o de CrÃ©dito">CartÃ£o de CrÃ©dito</option>
                        <option value="CartÃ£o de DÃ©bito">CartÃ£o de DÃ©bito</option>
                    </select>
                </div>

                <div class="checkout-group">
                    <label>Possui um cupom?</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="couponInput" placeholder="Digite o cupom" />
                        <button type="button" id="applyCouponBtn" class="btn-primary"
                            style="min-width:120px;">Aplicar</button>
                    </div>
                    <small id="couponStatus" style="color:#555;"></small>
                </div>


                <!-- RESUMO -->
                <div class="checkout-summary">
                    <h3>Resumo do Pedido</h3>
                    <div id="summaryItems"></div>
                    <p class="checkout-summary-total">Total: R$ <span id="summaryTotal">0,00</span></p>
                </div>

                <button type="submit" class="btn-primary full">Concluir Pedido</button>
            </form>

        </div>
    </main>

    <script type="module">
        import { createOrder } from "./js/store.js";
        import { getSwal } from "./js/swal-loader.js";

        const summaryItemsEl = document.getElementById("summaryItems");
        const summaryTotalEl = document.getElementById("summaryTotal");
        import { getCoupon, useCoupon } from "./js/store.js";

        let appliedCoupon = null;


        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        let frete = 0;

        function loadSummary() {
            let subtotal = 0;

            summaryItemsEl.innerHTML = cart.map(
                (p) => `
      <div class="checkout-summary-item">
        <span>${p.title}</span>
        <strong>R$ ${p.price.toFixed(2)}</strong>
      </div>
    `
            ).join("");

            cart.forEach((p) => subtotal += p.price);

            let final = calculateTotalWithCoupon(subtotal) + frete;

            summaryTotalEl.textContent = final.toFixed(2);
        }


        loadSummary();
        function calculateTotalWithCoupon(subtotal) {
            if (!appliedCoupon) return subtotal;

            if (appliedCoupon.type === "percent") {
                return subtotal - (subtotal * (appliedCoupon.value / 100));
            }

            if (appliedCoupon.type === "fixed") {
                return subtotal - appliedCoupon.value;
            }

            return subtotal;
        }


        // VIA CEP (preenche endereÃ§o automaticamente)
        document.getElementById("cepInput").addEventListener("blur", async () => {
            const cep = document.getElementById("cepInput").value.replace(/\D/g, "");

            if (cep.length !== 8) return;

            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();

            if (!data.erro) {
                document.getElementById("streetInput").value = data.logradouro || "";
                document.getElementById("districtInput").value = data.bairro || "";
                document.getElementById("cityInput").value = data.localidade || "";
                document.getElementById("stateInput").value = data.uf || "";
            }
        });

        document.getElementById("applyCouponBtn").addEventListener("click", async () => {
            const code = document.getElementById("couponInput").value.trim().toUpperCase();
            const statusEl = document.getElementById("couponStatus");

            if (!code) {
                statusEl.textContent = "Digite um cupom.";
                statusEl.style.color = "red";
                return;
            }

            try {
                const coupon = await getCoupon(code);

                if (!coupon) {
                    statusEl.textContent = "Cupom nÃ£o encontrado.";
                    statusEl.style.color = "red";
                    return;
                }

                if (!coupon.active) {
                    statusEl.textContent = "Cupom inativo.";
                    statusEl.style.color = "red";
                    return;
                }

                // validade
                if (coupon.expiresAt && coupon.expiresAt.toDate() < new Date()) {
                    statusEl.textContent = "Cupom expirado.";
                    statusEl.style.color = "red";
                    return;
                }


                // limite de uso
                // limite de uso â€“ se nÃ£o existir "uses", considera 0
                const currentUses = coupon.uses ?? 0;

                if (currentUses >= coupon.maxUses) {
                    statusEl.textContent = "Este cupom jÃ¡ atingiu o limite de uso.";
                    statusEl.style.color = "red";
                    return;
                }


                // TUDO OK â€” APLICAR CUPOM
                appliedCoupon = coupon;
                statusEl.textContent = `Cupom aplicado: ${coupon.code}`;
                statusEl.style.color = "green";

                loadSummary();

            } catch (error) {
                console.log(error);
                statusEl.textContent = "Erro ao validar cupom.";
                statusEl.style.color = "red";
            }
        });


        // FINALIZA PEDIDO
        document.getElementById("checkoutForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("nameInput").value.trim();
            const whatsapp = document.getElementById("whatsappInput").value.trim();
            const cep = document.getElementById("cepInput").value.trim();

            const address = {
                street: document.getElementById("streetInput").value.trim(),
                number: document.getElementById("numberInput").value.trim(),
                district: document.getElementById("districtInput").value.trim(),
                city: document.getElementById("cityInput").value.trim(),
                state: document.getElementById("stateInput").value.trim(),
            };

            const paymentMethod = document.getElementById("paymentMethod")?.value || "a definir";

            if (!paymentMethod) {
                const Swal = await getSwal();
                Swal.fire("AtenÃ§Ã£o", "Selecione um mÃ©todo de pagamento.", "warning");
                return;
            }

            const items = cart.map(p => ({
                title: p.title,
                price: Number(p.price),
                qty: p.qty ?? 1
            }));

            const subtotal = items.reduce((acc, p) => acc + p.price * p.qty, 0);
            const total = subtotal + frete;

            const pedido = {
                customerName: name,
                customerWhatsapp: whatsapp,
                cep,
                address,
                items,
                subtotal,
                frete,
                total,
                paymentMethod,
                coupon: appliedCoupon ? appliedCoupon.code : null,
                discount: appliedCoupon ? appliedCoupon.value : 0,
                discountType: appliedCoupon ? appliedCoupon.type : null,
                status: "pendente",
                createdAt: new Date().toISOString()
            };


            await createOrder(pedido);
            if (appliedCoupon) {
                await useCoupon(appliedCoupon.code);
            }


            localStorage.removeItem("cart");

            const Swal = await getSwal();
            Swal.fire({
                icon: "success",
                title: "Pedido concluÃ­do!",
                text: "Seu pedido foi registrado com sucesso!",
                confirmButtonText: "Voltar ao inÃ­cio"
            }).then(() => {
                window.location.href = "./index.html";
            });
        });
    </script>

</body>

</html>