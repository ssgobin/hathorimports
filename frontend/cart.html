<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carrinho - Hathor Imports</title>
    <link rel="stylesheet" href="assets/style.css" />
    <link rel="stylesheet" href="assets/cart-styles.css" />
  </head>
  <body>
    <!-- Header ser√° carregado dinamicamente -->
    <div id="header-container"></div>

    <main class="cart-page">
      <!-- Cabe√ßalho do Carrinho -->
      <div class="cart-header">
        <h1 class="cart-title">Meu Carrinho</h1>
        <p class="cart-subtitle">
          Revise seus itens antes de finalizar a compra
        </p>
      </div>

      <!-- Layout Principal -->
      <div class="cart-layout">
        <!-- Lista de Itens -->
        <div class="cart-items-container">
          <!-- Loading State -->
          <div id="cart-loading" class="cart-loading" style="display: none">
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
            <div class="skeleton-item"></div>
          </div>

          <!-- Empty State -->
          <div id="cart-empty" class="cart-empty" style="display: none">
            <div class="empty-icon">üõí</div>
            <h2 class="empty-title">Seu carrinho est√° vazio</h2>
            <p class="empty-text">Adicione produtos incr√≠veis da nossa loja!</p>
            <a href="store.html" class="btn-shop">
              <span>üî•</span>
              <span>Explorar Produtos</span>
            </a>
          </div>

          <!-- Lista de Itens -->
          <div id="cart-items" class="cart-items">
            <!-- Itens ser√£o inseridos aqui via JavaScript -->
          </div>
        </div>

        <!-- Resumo do Pedido -->
        <aside class="cart-summary">
          <h2 class="summary-title">Resumo do Pedido</h2>

          <!-- Valores -->
          <div class="summary-values">
            <div class="summary-row">
              <span class="summary-label">Subtotal</span>
              <span class="summary-value" id="summary-subtotal">R$ 0,00</span>
            </div>
            <div class="summary-row" id="discount-row" style="display: none">
              <span class="summary-label">Desconto</span>
              <span class="summary-value discount" id="summary-discount"
                >- R$ 0,00</span
              >
            </div>
            <div class="summary-row">
              <span class="summary-label">Frete</span>
              <span class="summary-value shipping" id="summary-shipping"
                >R$ 0,00</span
              >
            </div>
            <div class="summary-row summary-total">
              <span class="summary-label">Total</span>
              <span class="summary-value" id="summary-total">R$ 0,00</span>
            </div>
          </div>

          <!-- Cupom de Desconto -->
          <div class="coupon-section">
            <div class="coupon-title">Cupom de Desconto</div>

            <!-- Input de Cupom -->
            <div id="coupon-input-container" class="coupon-input-group">
              <input
                type="text"
                id="coupon-input"
                class="coupon-input"
                placeholder="Digite o cupom"
                maxlength="20"
              />
              <button id="btn-apply-coupon" class="btn-apply-coupon">
                Aplicar
              </button>
            </div>

            <!-- Cupom Aplicado -->
            <div
              id="coupon-applied"
              class="coupon-applied"
              style="display: none"
            >
              <span class="coupon-applied-text">
                <strong id="applied-coupon-code"></strong> aplicado!
              </span>
              <button
                id="btn-remove-coupon"
                class="btn-remove-coupon"
                title="Remover cupom"
              >
                ‚úï
              </button>
            </div>
          </div>

          <!-- Info de Frete Gr√°tis -->
          <div
            id="free-shipping-info"
            class="shipping-info"
            style="display: none"
          >
            üéâ Voc√™ ganhou frete gr√°tis!
          </div>

          <!-- Bot√µes de A√ß√£o -->
          <div class="summary-actions">
            <button id="btn-checkout" class="btn-checkout">
              Finalizar Compra
            </button>
            <a href="store.html" class="btn-continue"> Continuar Comprando </a>
          </div>
        </aside>
      </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts -->
    <script type="module">
      import { loadHeader } from "./js/loadHeader.js";
      import {
        getCart,
        updateQuantity,
        removeFromCart,
        clearCart,
        applyCoupon,
        removeCoupon,
        getCartSummary,
      } from "./js/cart-improved.js";
      import { showNotification } from "./js/notifications.js";

      // Carregar header
      loadHeader();

      // Elementos DOM
      const cartItemsContainer = document.getElementById("cart-items");
      const cartEmpty = document.getElementById("cart-empty");
      const cartLoading = document.getElementById("cart-loading");
      const summarySubtotal = document.getElementById("summary-subtotal");
      const summaryDiscount = document.getElementById("summary-discount");
      const summaryShipping = document.getElementById("summary-shipping");
      const summaryTotal = document.getElementById("summary-total");
      const discountRow = document.getElementById("discount-row");
      const freeShippingInfo = document.getElementById("free-shipping-info");
      const couponInput = document.getElementById("coupon-input");
      const btnApplyCoupon = document.getElementById("btn-apply-coupon");
      const couponInputContainer = document.getElementById(
        "coupon-input-container"
      );
      const couponApplied = document.getElementById("coupon-applied");
      const appliedCouponCode = document.getElementById("applied-coupon-code");
      const btnRemoveCoupon = document.getElementById("btn-remove-coupon");
      const btnCheckout = document.getElementById("btn-checkout");

      // Formatar moeda
      function formatCurrency(value) {
        return new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(value);
      }

      // Renderizar item do carrinho
      function renderCartItem(item) {
        const itemDiv = document.createElement("div");
        itemDiv.className = "cart-item";
        itemDiv.dataset.itemId = item.id;

        itemDiv.innerHTML = `
        <img src="${item.image}" alt="${item.name}" class="cart-item-image">
        
        <div class="cart-item-info">
          <h3 class="cart-item-title">${item.name}</h3>
          <div class="cart-item-meta">
            ${item.size ? `Tamanho: ${item.size}` : ""}
          </div>
          <div class="cart-item-price">${formatCurrency(item.price)}</div>
        </div>

        <div class="cart-item-actions">
          <div class="quantity-controls">
            <button class="qty-btn" data-action="decrease" data-id="${
              item.id
            }">‚àí</button>
            <span class="qty-value">${item.quantity}</span>
            <button class="qty-btn" data-action="increase" data-id="${
              item.id
            }">+</button>
          </div>
          <button class="btn-remove" data-id="${item.id}">
            üóëÔ∏è Remover
          </button>
        </div>
      `;

        return itemDiv;
      }

      // Renderizar carrinho
      function renderCart() {
        const cart = getCart();

        if (cart.length === 0) {
          cartItemsContainer.style.display = "none";
          cartEmpty.style.display = "block";
          document.querySelector(".cart-summary").style.display = "none";
          return;
        }

        cartEmpty.style.display = "none";
        cartItemsContainer.style.display = "flex";
        document.querySelector(".cart-summary").style.display = "block";

        cartItemsContainer.innerHTML = "";
        cart.forEach((item) => {
          cartItemsContainer.appendChild(renderCartItem(item));
        });

        updateSummary();
      }

      // Atualizar resumo
      function updateSummary() {
        const summary = getCartSummary();

        summarySubtotal.textContent = formatCurrency(summary.subtotal);
        summaryShipping.textContent =
          summary.shipping === 0 ? "Gr√°tis" : formatCurrency(summary.shipping);
        summaryTotal.textContent = formatCurrency(summary.total);

        // Mostrar/ocultar desconto
        if (summary.discount > 0) {
          discountRow.style.display = "flex";
          summaryDiscount.textContent = `- ${formatCurrency(summary.discount)}`;
        } else {
          discountRow.style.display = "none";
        }

        // Mostrar info de frete gr√°tis
        if (summary.shipping === 0 && summary.subtotal > 0) {
          freeShippingInfo.style.display = "block";
        } else {
          freeShippingInfo.style.display = "none";
        }

        // Atualizar UI do cupom
        const appliedCoupon = localStorage.getItem("appliedCoupon");
        if (appliedCoupon) {
          couponInputContainer.style.display = "none";
          couponApplied.style.display = "flex";
          appliedCouponCode.textContent = appliedCoupon;
        } else {
          couponInputContainer.style.display = "flex";
          couponApplied.style.display = "none";
        }
      }

      // Event Listeners
      cartItemsContainer.addEventListener("click", (e) => {
        const target = e.target;

        // Bot√µes de quantidade
        if (target.classList.contains("qty-btn")) {
          const action = target.dataset.action;
          const itemId = target.dataset.id;
          const item = getCart().find((i) => i.id === itemId);

          if (action === "increase") {
            updateQuantity(itemId, item.quantity + 1);
          } else if (action === "decrease" && item.quantity > 1) {
            updateQuantity(itemId, item.quantity - 1);
          }

          renderCart();
        }

        // Bot√£o remover
        if (
          target.classList.contains("btn-remove") ||
          target.closest(".btn-remove")
        ) {
          const btn = target.classList.contains("btn-remove")
            ? target
            : target.closest(".btn-remove");
          const itemId = btn.dataset.id;
          const item = getCart().find((i) => i.id === itemId);

          removeFromCart(itemId);
          showNotification(`${item.name} removido do carrinho`, "info");
          renderCart();
        }
      });

      // Aplicar cupom
      btnApplyCoupon.addEventListener("click", () => {
        const code = couponInput.value.trim().toUpperCase();

        if (!code) {
          showNotification("Digite um cupom v√°lido", "error");
          return;
        }

        const result = applyCoupon(code);

        if (result.success) {
          showNotification(
            `Cupom ${code} aplicado! ${result.discount}% de desconto`,
            "success"
          );
          couponInput.value = "";
          renderCart();
        } else {
          showNotification(result.message, "error");
        }
      });

      // Remover cupom
      btnRemoveCoupon.addEventListener("click", () => {
        removeCoupon();
        showNotification("Cupom removido", "info");
        renderCart();
      });

      // Enter no input de cupom
      couponInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          btnApplyCoupon.click();
        }
      });

      // Finalizar compra
      btnCheckout.addEventListener("click", () => {
        const cart = getCart();

        if (cart.length === 0) {
          showNotification("Seu carrinho est√° vazio", "error");
          return;
        }

        // Redirecionar para checkout
        window.location.href = "checkout.html";
      });

      // Inicializar
      renderCart();

      // Atualizar quando o carrinho mudar (de outras abas)
      window.addEventListener("storage", (e) => {
        if (e.key === "cart" || e.key === "appliedCoupon") {
          renderCart();
        }
      });
    </script>
  </body>
</html>
